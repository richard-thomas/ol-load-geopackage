# API Specification (OpenLayers OGC GeoPackage Loader)

This page describes the 3 exported functions/constants of the [ol-load-geopackage](README.md) module:

- [initSqlJsWasm()](#initsqljswasmsqljswasmdir) - initialisation: start loading of required sql.js WASM file
- [loadGpkg()](#loadgpkggpkgfile-displayprojection) - start loading and data extraction of GeoPackage
- [sql_js_version](#sql_js_version) - NPM version number of  underlying sql.js module

## initSqlJsWasm(sqlJsWasmDir)

Initialisation: start asynchronous loading of the required WebAssembly binary (sql-wasm.wasm) file (~660 kB) associated with the underlying sql.js module.

Parameters:

- string `sqlJsWasmDir` (optional): URL or path relative to root of folder containing sql-wasm.wasm file. Default value is root folder.

Returns a Promise which delivers:
- WebAssembly: sql.js SQLITE database access library

Note that unless you require access to sql.js outside ol-load-geopackage, then the returned promise can be ignored; [loadGpkg()](#loadgpkggpkgfile-displayprojection) will wait if necessary and handle any errors loading the WASM file. The only other reason to monitor the returned promise is if you are unlikely to invoke loadGpkg() for a long time and want to ensure the WASM has been successfully loaded.

If you want to load the associated WebAssembly binary (sql-wasm.wasm) from an external Content Delivery Network (CDN) then it is important that you load the WASM file that matches the version of the sql.js module being imported by ol-load-geopackage. Thus you will need to incorporate the _sql_js_version_ constant in the calling parameter, for example (from the proj4_example):

```javascript
import { initSqlJsWasm, loadGpkg , sql_js_version} from 'ol-load-geopackage';
const sqlJsWasmDir = 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/' + sql_js_version;
initSqlJsWasm(sqlJsWasmDir);
```

## loadGpkg(gpkgFile, displayProjection)

Begin asynchronous loading of a single OGC GeoPackage, then extract vector data tables into OpenLayers Vector Sources, transforming the data (if necessary) to match the specified display projection. If a "layer_styles" table is found (as generated by QGIS [Package Layers](https://docs.qgis.org/3.16/en/docs/user_manual/processing_algs/qgis/database.html#package-layers) Processing Toolbox command), it will extract the constituent SLD XML styling data associated with each vector data table.

Parameters:

- string `gpkgFile`: OGC GeoPackage file URL or path relative to root
- string `displayProjection`: Map display projection for output sources (e.g. 'EPSG:3857'). Note that projections not built in to OpenLayers must be defined before calling the function. This is most easily done using the Proj4JS library  - see Proj4 [Example](README.md#examples-in-github-repository).

Returns a Promise which delivers an array of 2 objects:

```javascript
[dataFromGpkg, sldsFromGpkg]
```

- object `dataFromGpkg`: data tables (OpenLayers vector sources, indexed by table name),
- object `sldsFromGpkg`: styles (SLD layer_styles XML strings, indexed by layer name)

For information only, the original data projection (SRS ID) will be returned as the string Property "origProjection" of each data source, so can be accessed with:

```javascript
dataFromGpkg[table].getProperties()["origProjection"]
```

Notes:

1. After loading the GeoPackage file, extraction of GeoPackage data will wait (if necessary) for the loading of the sql.js WASM file to complete (as initiated by [initSqlJsWasm()](#initsqljswasmsqljswasmdir)).
2. `sldsFromGpkg` will be an empty object if no table named "layer_styles" is found in the GeoPackage.
3. In the output GeoPackage from QGIS [Package Layers](https://docs.qgis.org/3.16/en/docs/user_manual/processing_algs/qgis/database.html#package-layers) the "table name" used for each vector data table will be exactly the same as the "layer name" used to index the SLD style strings in the "layer_styles" table.

Errors thrown on these events:
- Unable to load WebAssembly binary (sql-wasm.wasm)
- Unable to load requested OGC GeoPackage
- Missing requested display projection
- Missing a data projection (from any of Geopackage tables)


## sql_js_version

Constant string value: NPM version number of the underlying sql.js module. This is useful if you want to load the associated WebAssembly binary (sql-wasm.wasm) from an external CDN - details in earlier section: [initSqlJsWasm()](#initsqljswasmsqljswasmdir).
